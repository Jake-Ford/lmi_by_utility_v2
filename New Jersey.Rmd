---
title: "New Jersey"
output: 
  rmdformats::downcute:
    toc_depth: 3
---



```{r setup, include=FALSE}

source('helper_functions.R')
load_packages()


```

# Overview

We focus on the New Jersey Community Solar Energy Program (CSEP) market. New Jersey residents are served by a variety of electric utilities, seen below: 

```{r message=FALSE, warning=FALSE, include=FALSE}
temp_util <- st_read("utility_zones/NJ/Electric_Utilities_Territory_Map_of_New_Jersey.shp") %>%
  mutate(new_name = case_when(
    grepl("Municipal", NAME) ~ "Municipal",
    TRUE ~ NAME
  ))

temp_util <- st_make_valid(temp_util)

nj_geo_qual <- st_read("data/NJ/hud_80pct_80ami/Low_to_Moderate_Income_Population_by_Block_Group.shp") %>%
  mutate(total_pop = as.integer(Lowmoduniv),
         geo_tag = case_when(
           Lowmod_pct >= 0.8 ~ 1,
           TRUE ~ 0
         )
         )

  
```








```{r message=FALSE, warning=FALSE, include=FALSE}

get_tracts <- get_acs(
  geography="tract", 
  state="NJ",
  variables=c("Median Income" = "S1901_C01_012E"),
  year=2019, 
  geometry=TRUE) %>%
  mutate(MedInc = estimate) %>%
  select(geoid=GEOID, geometry)



```





```{r message=FALSE, warning=FALSE, include=FALSE}
chas_df <- load_chas() %>%
    mutate(State_Name = case_when(
    state == 17 ~ "Illinois",
    state == 25 ~ "Massachusetts",  
    state == 27 ~ "Minnesota",  
    state == 34 ~ "New Jersey",
    state == 35 ~ "New Mexico",  
    state == 36 ~ "New York",
    state == 06 ~ "California",
    TRUE ~ "Other"
  )) %>%
  filter(State_Name == "New Jersey")



add_geo <- merge(chas_df, get_tracts) 

add_geo <- st_as_sf(add_geo)


temp_util <- st_transform(temp_util, st_crs(add_geo)) %>%
  st_make_valid()
```




```{r echo=FALSE, message=FALSE, warning=FALSE}

pal5 <- colorFactor(
  palette="viridis",
  domain=temp_util$new_name
)

leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=temp_util,
              group="Utility Zones",
              stroke=TRUE,
              color=~pal5(temp_util$new_name),
              dashArray="3",
              fillOpacity=0.5,
              popup=paste("Utility Zone: ", temp_util$new_name)) %>%
  addLegend(position="bottomright",
            pal=pal5,
            values=temp_util$new_name,
            title="Solstice NJ Utilities")
```
  
For the CSEP program, both geo- and LMI verifications are allowed. 


# Geoqualification

The New Jersey CSEP program allows for geoqualification. Residents must reside within a census block group in which 80 percent or more of the households earn less than 80 percent of the area median income, as determined by data from the U.S. Department of Housing and Urban Development. 

The below map shows the distribution of these households as defined by HUD: 

```{r echo=FALSE, message=FALSE, warning=FALSE}




pal5 <- colorFactor(
  palette=c("white", "darkred"),
  domain=nj_geo_qual$geo_tag
)


leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=nj_geo_qual,
              group="Block Groups",
             # stroke = TRUE,
              color = ~pal5(nj_geo_qual$geo_tag),
              fillOpacity=0.75,
              popup=paste("Census Block Group: ", nj_geo_qual$GEOID, "<br>",
                          "Population: ", nj_geo_qual$total_pop)) %>%
  addLegend(position="bottomright",
            pal=pal5,
            values=nj_geo_qual$geo_tag,
            title="NJ Geoqualified Census Block Groups")  %>%
  
    addPolygons(data=temp_util,
              group="Utility Zones",
              stroke=TRUE,
              color="black",
              dashArray="3",
              fillOpacity=0,
              popup=paste("Utility: ", temp_util$new_name)) %>%
  
      addLayersControl(
    overlayGroups=c( "Block Groups", "Utility Zones"),  # Update the order for consistency
    options = layersControlOptions(collapsed = FALSE)
  )


```


The table below shows that New Jersey has relatively limited geoqualification, less than 10% of the state population resides within a qualified census block group. 


```{r echo=FALSE, message=FALSE, warning=FALSE}

temp_table <- nj_geo_qual %>% 
  st_drop_geometry() %>%
  mutate(var = 1) %>%
  group_by(var) %>%
  summarize(Population = sum(total_pop[geo_tag==1])) %>%
  mutate(Percentage = Population/sum(nj_geo_qual$total_pop)) %>%
  select(Population, Percentage)
  

datatable(temp_table, caption = "California Geoqualified Population") %>%
    formatCurrency('Population',currency = "", interval = 3, mark = ",") %>%
    formatPercentage('Percentage',digit=2) 


```





```{r message=FALSE, warning=FALSE, include=FALSE}

temp_table %>%
#  filter(Geoqualified=="Yes") %>%
  write_csv("final_data/nj_geo_total.csv")

```


When broken down by utility zone, we see most of the customers who are geoqualified reside within PSEG: 

```{r echo=FALSE, message=FALSE, warning=FALSE}





temp_util <- st_transform(temp_util, st_crs(nj_geo_qual))

temp_table <- nj_geo_qual %>% 
  st_point_on_surface() %>%
  st_make_valid() %>%
  st_join(temp_util %>% select(Utility = new_name)) %>%
  st_drop_geometry() %>%
  mutate(Geoqualified = case_when(
    geo_tag == 1 ~ "Yes",
    TRUE ~ "No"
  )) %>%
  group_by(Utility) %>%
  summarize(Geoqualified = sum(total_pop[geo_tag == 1]),
            NonGeoqualified = sum(total_pop[geo_tag == 0])) %>%
  mutate(
    Pct_Geoqualified = Geoqualified/(Geoqualified + NonGeoqualified),
    Total =Geoqualified +NonGeoqualified  ) %>%
  #summarize(Population = sum(total_pop)) %>%
  adorn_totals("row")

temp_table$Pct_Geoqualified[nrow(temp_table)] <- temp_table$Geoqualified[nrow(temp_table)]/temp_table$NonGeoqualified[nrow(temp_table)]


datatable(temp_table, caption = "New Jersey Geoqualified Population by Utility") %>%
    formatCurrency('Geoqualified',currency = "", interval = 3, digits = 0, mark = ",") %>%
    formatCurrency('NonGeoqualified',currency = "", interval = 3, digits = 0, mark = ",") %>%
    formatPercentage('Pct_Geoqualified',interval = 3, digits = 0, mark = ",") %>%
    formatCurrency('Total',currency = "", interval = 3, digits = 0, mark = ",") 



```











# LMI Qualificaiton

Self-attestation by the customer that their household income is less than 80 percent of the area median income, as determined by data from the U.S. Department of Housing and Urban Development, provided on a standard form to be approved by the Board and signed by the customer and recorded through an authorized administrator procured by the EDCs


We use HUD data that summarizes the total number of households living at or under 80% AMI. This is the total LMI addressable market in New Jersey that could be determined via self-attestation. 




```{r echo=FALSE, message=FALSE, warning=FALSE}



pal5 <- colorNumeric(
  palette=c("Oranges"),
  domain=add_geo$AMI_80
)


leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=add_geo,
              group="LMI",
             # stroke = TRUE,
              color = ~pal5(add_geo$AMI_80),
              fillOpacity=0.75,
              popup=paste("Census Block Group: ", add_geo$GEOID, "<br>",
                          "Population < 80% AMI: ", add_geo$AMI_80)) %>%
  addLegend(position="bottomright",
            pal=pal5,
            values=add_geo$AMI_80,
            title="NJ LMI Population")  %>%
  
    addPolygons(data=temp_util,
              group="Utility Zones",
              stroke=TRUE,
              color="black",
              dashArray="3",
              fillOpacity=0,
              popup=paste("Utility: ", temp_util$new_name)) %>%
  
      addLayersControl(
    overlayGroups=c( "LMI", "Utility Zones"),  # Update the order for consistency
    options = layersControlOptions(collapsed = FALSE)
  )


```











```{r message=FALSE, warning=FALSE, include=FALSE}
nj_tracts <- get_acs(
  geography="tract", 
  state="NJ",
  variables=c("Total_Pop" = "B01001_001","snap_hh" = "B22001_002","snap_pop" = "B19058_002"
              
              ),
  year=2019, 
  geometry=TRUE) %>%
  group_by(GEOID) %>%
  summarize(total_pop = estimate[variable=="Total_Pop"],
            snap_hh = estimate[variable=="snap_hh"],
            snap_pop = estimate[variable=="snap_pop"])







total_nj_tracts <- cbind(add_geo, nj_tracts)

```


# LIFT Solar

There are 145 community solar projects in New Jersey according to the LIFT solar database. 



```{r echo=FALSE, fig.height=10, fig.width=8, message=FALSE, warning=FALSE}

lift_df <- read.csv("data/groundswell_lift/cs-projects-2023-08-18.csv") 

lift_df <- separate(lift_df, GeoCode, into = c("long", "lat"), sep = ",")

lift_df <- st_as_sf(lift_df, coords = c("long", "lat"), crs = st_crs(get_tracts))



temp_df <- add_geo %>%
  filter(State_Name == "New Jersey") 

temp_lift <- lift_df %>%
  filter(State == "New Jersey")


pal_potLMI <- colorNumeric(
  palette = "viridis",
 # reverse=TRUE,
  domain = temp_lift$Potential...LMI.Subscribers)

pal_cap <- colorNumeric(
  palette = "viridis",
 # reverse=TRUE,
  domain = temp_lift$Project.Capacity.KW.AC)



pal <- colorNumeric(
  palette = "viridis",
 # reverse=TRUE,
  domain = temp_df$AMI_80)

pal2 <- colorNumeric(
  palette = "Purples",
 # reverse=TRUE,
  domain = temp_df$AMI_80_Pct)

pal3 <- colorNumeric(
  palette = "viridis",
 # reverse=TRUE,
  domain = total_nj_tracts$snap_hh)

library(tidyr)





map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=temp_util,
              group="Utility Zones",
              stroke=TRUE,
              color="black",
              dashArray="3",
              fillOpacity=0,
              popup=paste("Utility Zone: ", temp_util$new_name)
  ) %>%
  
  addPolygons(
    data = temp_df,
    group="80% AMI",  # This should be consistent with the group name in the addLegend function
    stroke=FALSE,
    smoothFactor=0.2,
    fillOpacity=0.85,
    color=~pal(AMI_80),
    popup=paste("Tract: ", temp_df$geoid, "<br>", 
                "HHs at 80% AMI: ", temp_df$AMI_80)
  ) %>%

  addLegend("bottomleft",
            group="80% AMI",  # This should be consistent with the group name in the addPolygons function
            pal = pal,
            values = temp_df$AMI_80,
            title="Number of HHs at 80% AMI"
  ) %>%
  
  # addPolygons(
  #   data=nm_df,
  #   group="80% AMI Percent",  # This should be consistent with the group name in the addLegend function
  #   stroke=FALSE,
  #   smoothFactor=0.2,
  #   fillOpacity=0.7,
  #   color=~pal2(AMI_80_Pct),
  #   popup=paste("Tract: ", nm_df$geoid, "<br>", 
  #               "Percent of HHs at 80% AMI: ", nm_df$AMI_80_Pct)
  # ) %>%
  # 
  # addLegend("bottomleft",
  #           group="80% AMI Percent",  # This should be consistent with the group name in the addPolygons function
  #           pal = pal2,
  #           values = nm_df$AMI_80_Pct,
  #           title="Percent of HHs at 80% AMI"
  # ) %>%
  
  addPolygons(
    data=total_nj_tracts,
    group="SNAP",
    stroke=FALSE,
    smoothFactor=0.2,
    fillOpacity=0.7,
    color=~pal3(snap_hh),
    popup=paste("Tract: ", total_nj_tracts$GEOID, "<br>",
                "Number of HHs Receiving SNAP: ", total_nj_tracts$snap_hh)
  ) %>%

  addLegend("bottomleft",
            group="SNAP",
            pal = pal3,
            values = total_nj_tracts$snap_hh,
            title="Number of HHs Receiving SNAP:"
  ) %>%
  
    addCircleMarkers(data = temp_lift,
                   group="Potential LMI Subscribers",
                   popup = ~paste("Program Name: ", Program.Name, "<br>",
                                  "Developer/Owner: ", Project.Developer.or.Owner, "<br>", 
                                  "Project Capacity: ", Project.Capacity.KW.AC, "<br>",
                                  "LMI Savings: ", LMI.Customer.Savings.., "<br>",
                                  "Potential LMI Subscribers: ", Potential...LMI.Subscribers),
                   radius = sqrt(temp_lift$Potential...LMI.Subscribers), 
                   color = ~pal_potLMI(Potential...LMI.Subscribers)) %>%
  addLegend("bottomright",
            group="Potential LMI Subscribers",  # This should be consistent with the group name in the addPolygons function
            pal = pal_potLMI,
            values = temp_lift$Potential...LMI.Subscribers,
            title="Potential LMI Subscribers") %>%

    ## Project Capacity ## 
  
  addCircleMarkers(data = temp_lift,
                   group="Project Capacity",
                   popup = ~paste("Program Name: ", Program.Name, "<br>",
                                  "Developer/Owner: ", Project.Developer.or.Owner, "<br>", 
                                  "Project Capacity: ", Project.Capacity.KW.AC, "<br>",
                                  "LMI Savings: ", LMI.Customer.Savings.., "<br>",
                                  "Potential LMI Subscribers: ", Potential...LMI.Subscribers),
                   radius = sqrt(temp_lift$Project.Capacity.KW.AC), 
                   color = ~pal_cap(Project.Capacity.KW.AC)) %>%
  addLegend("topleft",
             group="Project Capacity",  # This should be consistent with the group name in the addPolygons function
            pal = pal_cap,
            values = temp_lift$Project.Capacity.KW.AC,
            title="Project Capacity") %>%


  addLayersControl(
    overlayGroups=c( "80% AMI", "Utility Zones", "SNAP","Potential LMI Subscribers", "Project Capacity"),  # Update the order for consistency
    options = layersControlOptions(collapsed = FALSE)
  )

map %>%
 hideGroup("SNAP") %>% hideGroup("80% AMI") %>% hideGroup("Project Capacity")

```



```{r echo=FALSE, message=FALSE, warning=FALSE}



total_nj_tracts <- st_transform(total_nj_tracts, st_crs(temp_util)) %>%
  st_make_valid()


temp_table <- total_nj_tracts %>% 
  st_point_on_surface() %>%
  st_make_valid() %>%
  st_join(temp_util %>% select(Utility = new_name)) %>%
  st_drop_geometry() %>%
  group_by(Utility) %>%
  summarize(`80% AMI` = sum(AMI_80),
            SNAP = sum(snap_hh),
            `Total Pop` = sum(total_pop))%>%
  adorn_totals("row")


datatable(temp_table, caption = "New Jersey LMI Population by Utility") %>%
    formatCurrency('80% AMI',currency = "", interval = 3, digits = 0, mark = ",") %>%
    formatCurrency('SNAP',currency = "", interval = 3, digits = 0, mark = ",") %>%
    formatCurrency('Total Pop',currency = "", interval = 3, digits = 0, mark = ",") 




```





```{r message=FALSE, warning=FALSE, include=FALSE}

temp_table %>%
  filter(Utility=="Total") %>%
  write_csv("final_data/nj_lmi_total.csv")


```

