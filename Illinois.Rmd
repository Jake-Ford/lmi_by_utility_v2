---
title: "Illinois"
output: 
  rmdformats::downcute:
    toc_depth: 3
---


# Overview

There two programs to consider in Illinois for LMI population estimation: Solar for All (SFA) and the Microsoft Engie. Each program has unique geo- and LMI qualifications. 

```{r setup, include=FALSE}

source('helper_functions.R')
load_packages()



```



## Utility Zones

There are two main utility zones in Illinois Solstice works with: Ameren and ComEd. Note a third utility, MidAmerican, does have a slight bit of coverage into Mercer and Henry Counties where Ameren and ComEd coverage ends. 



```{r message=FALSE, warning=FALSE, include=FALSE}


hifld_df <- st_read("utility_zones/HIFLD/Electric_Retail_Service_Territories (1)/Electric_Retail_Service_Territories.shp") 

state_list <- c("IL", "MA", "MN", "NJ", "NM", "NY",  "CA", "DE")


temp_util <- hifld_df %>%
  filter(ID %in% c(56697, 4110,12341)) %>%
  mutate(new_name = case_when(
    ID == 56697 ~ "Ameren",
    ID == 4110 ~ "ComEd",
    ID == 12341 ~ "MidAmerican"
  ))

get_tracts <- get_acs(
  geography="tract", 
  state="IL",
  variables=c("total_pop" = "B01001_001"),
  year=2019, 
  geometry=TRUE) %>%
  mutate(total_pop = estimate) %>%
  select(geoid=GEOID, geometry, total_pop) 


new_tracts <- get_acs(
  geography="tract", 
  state="IL",
  variables=c("total_pop" = "B01001_001"),
  year=2020, 
  geometry=TRUE) %>%
  mutate(total_pop = estimate) %>%
  select(geoid=GEOID, geometry, total_pop) 


```



```{r message=FALSE, warning=FALSE, include=FALSE}
chas_df <- load_chas() %>%
    mutate(State_Name = case_when(
    state == 17 ~ "Illinois",
    state == 25 ~ "Massachusetts",  
    state == 27 ~ "Minnesota",  
    state == 34 ~ "New Jersey",
    state == 35 ~ "New Mexico",  
    state == 36 ~ "New York",
    state == 06 ~ "California",
    TRUE ~ "Other"
  ))

il_counties <- get_acs(geography="county",
                       variables = c("Total_Pop" = "B01001_001","snap_hh" = "B22001_002","snap_pop" = "B19058_002"), 
              state = "IL", 
              year = 2021,
              geometry = TRUE) %>%
  group_by(NAME, GEOID) %>%
  summarize(total_pop = estimate[variable=="Total_Pop"],
            snap_hh = estimate[variable=="snap_hh"],
            snap_pop = estimate[variable=="snap_pop"])



il_tracts <- get_acs(
  geography="tract", 
  state="IL",
  variables=c("snap_hh" = "B22001_002",
              "snap_pop" = "B19058_002",
              "medicaid_1" = "C27007_004",
              "medicaid_2" = "C27007_007",
              "medicaid_3" = "C27007_010",
              "medicaid_4" = "C27007_014",
              "medicaid_5" = "C27007_017",
              "medicaid_6" = "C27007_020",
              "Total_Pop" = "B01001_001"
              
              ),
  year=2021, 
  geometry=TRUE) %>%
  group_by(GEOID) %>%
  summarize(snap_hh = estimate[variable=="snap_hh"],
            snap_pop = estimate[variable=="snap_pop"],
            medicaid_pop =estimate[variable=="medicaid_1"] + 
                          estimate[variable=="medicaid_2"] +
                          estimate[variable=="medicaid_3"] +
                          estimate[variable=="medicaid_4"] +
                          estimate[variable=="medicaid_5"] +
                          estimate[variable=="medicaid_6"] ,
            total_pop = estimate[variable=="Total_Pop"])

add_geo <- merge(chas_df, get_tracts) 

add_geo <- st_as_sf(add_geo)

il_geo <- add_geo %>%
  filter(State_Name=="Illinois")

temp_util <- st_transform(temp_util, st_crs(il_geo)) %>%
  st_make_valid()
```



```{r echo=FALSE, message=FALSE, warning=FALSE}

pal5 <- colorFactor(
  palette="viridis",
  domain=temp_util$new_name
)

# Unhide for Mercer and Henry County MidAmerican Utility deep dive
# il_counties <- il_counties %>%
#   filter(GEOID == 17073 | GEOID == 17131)

leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=temp_util,
              group="Utility Zones",
              stroke=TRUE,
              color=~pal5(temp_util$new_name),
              dashArray="3",
              fillOpacity=0.25,
              popup=paste("Utility Zone: ", temp_util$new_name)) %>%
  addLegend(position="bottomright",
            pal=pal5,
            values=temp_util$new_name,
            title="Solstice IL Utilities") %>%
  addPolygons(data=il_counties, 
              stroke=TRUE,
              color="black",
              dashArray="3",
              group="Counties",
              fillOpacity=0,
              popup=paste("Utility Zone: ", il_counties$NAME)) %>%
  # addPolygons(data = il_tracts,
  #             color = "red",
  #             fillOpacity = .5,
  #             popup=paste("GEOID: ", il_tracts$geoid)) %>%
  
  
  addLayersControl(
    overlayGroups=c( "Counties", "Utility Zones"),  # Update the order for consistency
    options = layersControlOptions(collapsed = FALSE)
  )
```



The below table shows the total sums of the demographics and LMI populations by utility zone coverage. ComEd covers about three times as much population as Ameren in Illinois. 



```{r echo=FALSE, message=FALSE, warning=FALSE}
## Mercer Demographic Table



temp <- il_tracts %>% 
  st_point_on_surface() %>%
  st_make_valid() %>%
  st_join(temp_util %>% select(NAME)) %>%
  st_drop_geometry() %>%
  group_by(Name = NAME) %>%
  filter(!is.na(Name)) %>%
  summarize(`Total Pop` = sum(total_pop),
            `SNAP` = sum(snap_pop),
            `Medicaid` = sum(medicaid_pop)) %>%
  adorn_totals("row") 



temp_get_ami <- il_geo %>%
  st_point_on_surface() %>%
  st_make_valid() %>%
  st_join(temp_util %>% select(NAME)) %>%
  st_drop_geometry() %>%
  group_by(Name = NAME) %>%
  filter(!is.na(Name)) %>%
  summarize(`100% AMI` = sum(AMI_100),
            `80% AMI` = sum(AMI_80)) %>%
  adorn_totals("row") %>%
  select(-Name) 


  
temp_total <- cbind(temp, temp_get_ami)

datatable(temp_total, caption = "Total Illinois Demographics by Utility Coverage, Sources: ACS 2021 and HUD CHAS")%>%
  formatCurrency('Total Pop', currency = "", mark = ",", interval = 3, digits = 0) %>%
  formatCurrency('SNAP', currency = "", mark = ",", interval = 3, digits = 0) %>%
  formatCurrency('Medicaid', currency = "", mark = ",", interval = 3, digits = 0) %>%
  formatCurrency('100% AMI', currency = "", mark = ",", interval = 3, digits = 0) %>%
  formatCurrency('80% AMI', currency = "", mark = ",", interval = 3, digits = 0) 




```





# Geoqualification

The Microsoft Engie project uses a geoqualification map that was designed by Solstice. More details on the data used to create this map can be found [on the Coda Page](https://coda.io/d/Product_dEW7ukwF5E7/MSFT-Engie-Geospatial-Methods_suaHJ#_luvGQ). 

For the SFA Program, an initial set of census tracts were designed ("legacy" layer in the [online map](https://elevate.maps.arcgis.com/apps/webappviewer/index.html?id=924cfbc202f24e22a88f07f21423fad0)), but an updated version was made available ("current" layer). Both layers can be used until June 2024. Each of these layers are shown on the below map. 




```{r message=FALSE, warning=FALSE, include=FALSE}
engie_tracts <- st_read("/Users/jacobford/Library/CloudStorage/GoogleDrive-jake@solstice.us/Shared drives/Product | Jake/Geocoding/Engie:Microsoft Geodata/MFST Engie Qualified Tracts.shp") 

# Population Var: TotalPp

engie_tracts <- st_transform(engie_tracts, st_crs(get_tracts))

old_sfa <- st_read("/Users/jacobford/Library/CloudStorage/GoogleDrive-jake@solstice.us/Shared drives/Product | Jake/Geocoding/ILSFA/Qualified Tracts/ILSFA Qualified Tracts.shp")

old_sfa <- st_transform(old_sfa, st_crs(get_tracts))


new_sfa <- st_read("/Users/jacobford/Library/CloudStorage/GoogleDrive-jake@solstice.us/Shared drives/Product | Jake/Geocoding/ILSFA/Updated Map June 2023/Tract_ILSFA_IncomeEligible_POLY_Map-Data/Tract_ILSFA_IncomeEligible_POLY.shp") %>%
  filter(IncomeElig==1)

new_sfa <- st_transform(new_sfa, st_crs(get_tracts))


combined_sfa <- st_read("/Users/jacobford/Library/CloudStorage/GoogleDrive-jake@solstice.us/Shared drives/Product | Jake/Geocoding/ILSFA/Updated Map June 2023/combined_ilsfa_maps.geojson")

combined_sfa <- st_transform(combined_sfa, st_crs(get_tracts))


get_tracts <- get_tracts %>%
  mutate(
    engie = (geoid %in% engie_tracts$GEOID),
    old_sfa = (geoid %in% old_sfa$GEOID)
  )

new_tracts <- new_tracts %>%
  mutate(

    new_sfa = (geoid %in% new_sfa$GEOID)
    
  )

```





```{r echo=FALSE, message=FALSE, warning=FALSE}
leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=engie_tracts,
              group="Engie",
             # stroke=TRUE,
              color="lightgreen",
              dashArray="3",
              fillOpacity=0.55,
              popup=paste("GEOID: ", engie_tracts$GEOID)) %>%
    addPolygons(data=old_sfa,
              group="Legacy SFA",
            #  stroke=TRUE,
              color="purple",
              dashArray="3",
              fillOpacity=0.55,
              popup=paste("GEOID: ", old_sfa$GEOID)) %>%
  
    addPolygons(data=new_sfa,
              group="Current SFA",
              #stroke=TRUE,
              color="darkred",
              dashArray="3",
              fillOpacity=0.55,
              popup=paste("GEOID: ", new_sfa$GEOID)) %>%
  
    addPolygons(data=combined_sfa,
              group="Combined SFA",
             # stroke=TRUE,
              color="blue",
              dashArray="3",
              fillOpacity=0.55,
              popup=paste("GEOID: ", combined_sfa$GEOID)) %>%

  
  
  addLayersControl(
    overlayGroups=c( "Engie", "Legacy SFA", "Current SFA", "Combined SFA"),  # Update the order for consistency
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  hideGroup("Legacy SFA") %>% hideGroup("Current SFA") %>% hideGroup("Combined SFA")
```

Note in the below table, you'll see the Engie map covers nearly 62% of the state's population. The combined coverage of SFA using both the legacy and current layers will result in roughly 45% of the state being covered; however, the current SFA map uses census tracts from the 2020 census, whereas the legacy SFA map uses census tracts from the 2010 census. This makes 

```{r echo=FALSE, message=FALSE, warning=FALSE}

# get 2020 population covered by combined layer

temp_centroids <- combined_sfa %>%
  st_point_on_surface() %>%
  st_join(new_tracts %>% select(geoid, total_pop)) %>%
  st_drop_geometry() %>%
  group_by(geoid) %>%
  filter(!is.na(geoid)) %>%
  summarize(total_pop = max(total_pop))


temp <- data.frame(Method = c("Engie", "Legacy SFA", "Current SFA", "Combined SFA"),
                   Population = c(sum(get_tracts$total_pop[get_tracts$engie==1]),
                                 sum(get_tracts$total_pop[get_tracts$old_sfa==1]),
                                 sum(new_tracts$total_pop[new_tracts$new_sfa==1]),
                                 sum(temp_centroids$total_pop))
                   )

temp$`Percent of Total` <- temp$Population/sum(new_tracts$total_pop)




datatable(temp, caption = "Illinois Geoqualification Method Totals")%>%
  formatCurrency('Population', currency = "", mark = ",", interval = 3, digits = 0) %>%
  formatPercentage('Percent of Total', digits = 2)

```







# LMI Qualification

For the Engie program, we use 100% AMI, SNAP and Medicaid households to estimate LMI populations. For the SFA program, the requirements slightly differ with a lower AMI percentage of 80%, with the same SNAP and Medicaid use cases. 


# LIFT Solar

```{r message=FALSE, warning=FALSE, include=FALSE}
il_tracts <- get_acs(
  geography="tract", 
  state="IL",
  variables=c("Total_Pop" = "B01001_001","snap_hh" = "B22001_002","snap_pop" = "B19058_002"
              
              ),
  year=2019, 
  geometry=TRUE) %>%
  group_by(GEOID) %>%
  summarize(total_pop = estimate[variable=="Total_Pop"],
            snap_hh = estimate[variable=="snap_hh"],
            snap_pop = estimate[variable=="snap_pop"])







total_il_tracts <- cbind(il_geo, il_tracts)

```



There are 13 community solar projects in New Jersey according to the LIFT solar database. 



```{r echo=FALSE, fig.height=10, fig.width=8, message=FALSE, warning=FALSE}

lift_df <- read.csv("data/groundswell_lift/cs-projects-2023-08-18.csv") 

lift_df <- separate(lift_df, GeoCode, into = c("long", "lat"), sep = ",")

lift_df <- st_as_sf(lift_df, coords = c("long", "lat"), crs = st_crs(get_tracts))



temp_df <- add_geo %>%
  filter(State_Name == "Illinois") 

temp_lift <- lift_df %>%
  filter(State == "Illinois")


pal_potLMI <- colorNumeric(
  palette = "viridis",
 # reverse=TRUE,
  domain = temp_lift$Potential...LMI.Subscribers)

pal_cap <- colorNumeric(
  palette = "viridis",
 # reverse=TRUE,
  domain = temp_lift$Project.Capacity.KW.AC)



pal <- colorNumeric(
  palette = "viridis",
 # reverse=TRUE,
  domain = temp_df$AMI_80)

pal2 <- colorNumeric(
  palette = "Purples",
 # reverse=TRUE,
  domain = temp_df$AMI_80_Pct)

pal3 <- colorNumeric(
  palette = "viridis",
 # reverse=TRUE,
  domain = total_il_tracts$snap_hh)

library(tidyr)





map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=temp_util,
              group="Utility Zones",
              stroke=TRUE,
              color="black",
              dashArray="3",
              fillOpacity=0,
              popup=paste("Utility Zone: ", temp_util$comp_short)
  ) %>%
  
  addPolygons(
    data = temp_df,
    group="80% AMI",  # This should be consistent with the group name in the addLegend function
    stroke=FALSE,
    smoothFactor=0.2,
    fillOpacity=0.85,
    color=~pal(AMI_80),
    popup=paste("Tract: ", temp_df$geoid, "<br>", 
                "HHs at 80% AMI: ", temp_df$AMI_80)
  ) %>%

  addLegend("bottomleft",
            group="80% AMI",  # This should be consistent with the group name in the addPolygons function
            pal = pal,
            values = temp_df$AMI_80,
            title="Number of HHs at 80% AMI"
  ) %>%
  
  # addPolygons(
  #   data=nm_df,
  #   group="80% AMI Percent",  # This should be consistent with the group name in the addLegend function
  #   stroke=FALSE,
  #   smoothFactor=0.2,
  #   fillOpacity=0.7,
  #   color=~pal2(AMI_80_Pct),
  #   popup=paste("Tract: ", nm_df$geoid, "<br>", 
  #               "Percent of HHs at 80% AMI: ", nm_df$AMI_80_Pct)
  # ) %>%
  # 
  # addLegend("bottomleft",
  #           group="80% AMI Percent",  # This should be consistent with the group name in the addPolygons function
  #           pal = pal2,
  #           values = nm_df$AMI_80_Pct,
  #           title="Percent of HHs at 80% AMI"
  # ) %>%
  
  addPolygons(
    data=total_il_tracts,
    group="SNAP",
    stroke=FALSE,
    smoothFactor=0.2,
    fillOpacity=0.7,
    color=~pal3(snap_hh),
    popup=paste("Tract: ", total_il_tracts$GEOID, "<br>",
                "Number of HHs Receiving SNAP: ", total_il_tracts$snap_hh)
  ) %>%

  addLegend("bottomleft",
            group="SNAP",
            pal = pal3,
            values = total_il_tracts$snap_hh,
            title="Number of HHs Receiving SNAP:"
  ) %>%
  
    addCircleMarkers(data = temp_lift,
                   group="Potential LMI Subscribers",
                   popup = ~paste("Program Name: ", Program.Name, "<br>",
                                  "Developer/Owner: ", Project.Developer.or.Owner, "<br>", 
                                  "Project Capacity: ", Project.Capacity.KW.AC, "<br>",
                                  "LMI Savings: ", LMI.Customer.Savings.., "<br>",
                                  "Potential LMI Subscribers: ", Potential...LMI.Subscribers),
                   radius = sqrt(temp_lift$Potential...LMI.Subscribers), 
                   color = ~pal_potLMI(Potential...LMI.Subscribers)) %>%
  addLegend("bottomright",
            group="Potential LMI Subscribers",  # This should be consistent with the group name in the addPolygons function
            pal = pal_potLMI,
            values = temp_lift$Potential...LMI.Subscribers,
            title="Potential LMI Subscribers") %>%

    ## Project Capacity ## 
  
  addCircleMarkers(data = temp_lift,
                   group="Project Capacity",
                   popup = ~paste("Program Name: ", Program.Name, "<br>",
                                  "Developer/Owner: ", Project.Developer.or.Owner, "<br>", 
                                  "Project Capacity: ", Project.Capacity.KW.AC, "<br>",
                                  "LMI Savings: ", LMI.Customer.Savings.., "<br>",
                                  "Potential LMI Subscribers: ", Potential...LMI.Subscribers),
                   radius = sqrt(temp_lift$Project.Capacity.KW.AC), 
                   color = ~pal_cap(Project.Capacity.KW.AC)) %>%
  addLegend("topleft",
             group="Project Capacity",  # This should be consistent with the group name in the addPolygons function
            pal = pal_cap,
            values = temp_lift$Project.Capacity.KW.AC,
            title="Project Capacity") %>%


  addLayersControl(
    overlayGroups=c( "80% AMI", "Utility Zones", "SNAP","Potential LMI Subscribers", "Project Capacity"),  # Update the order for consistency
    options = layersControlOptions(collapsed = FALSE)
  )

map %>%
 hideGroup("SNAP") %>% hideGroup("80% AMI") %>% hideGroup("Project Capacity")

```

